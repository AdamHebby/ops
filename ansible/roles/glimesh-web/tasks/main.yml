---

- name: set a hostname
  hostname:
    name: "{{ inventory_hostname }}"

- name: Ensure .ssh directory exists.
  file:
    dest: "/root/.ssh"
    mode: 0700
    owner: root
    state: directory

- name: Install ssh key
  copy:
    src: "glimesh-deploy"
    dest: "/root/.ssh/id_rsa"
    mode: 0600
    owner: root

- name: Trust GitHub
  shell: ssh-keyscan github.com >> ~/.ssh/known_hosts

# - name: install elixir
#   apt:
#     deb: https://packages.erlang-solutions.com/erlang-solutions_2.0_all.deb

# - name: install required packages
#   apt:
#     pkg:
#       - esl-erlang
#       - elixir
#       - npm
#       - git
#       - openssl
#       - imagemagick
#     state: present
#     update_cache: yes

- name: install hex
  command: mix local.hex --force

- name: install rebar
  command: mix local.rebar --force

- name: ensure web_build_dir exists
  file:
    path: "{{ glimesh_web_build_dir }}"
    state: directory

- name: download glimesh.tv
  git:
    repo: https://github.com/Glimesh/glimesh.tv.git
    dest: "{{ glimesh_web_build_dir }}"
    recursive: true
    update: true
    force: true
    version: "{{ glimesh_version }}"
  register: glimesh

- name: register short git hash version
  command: git rev-parse --short HEAD
  args:
    chdir: "{{ glimesh_web_build_dir }}"
  register: glimesh_git_hash

- name: change version
  lineinfile:
    path: "{{ glimesh_web_build_dir }}/mix.exs"
    regexp: '^\s+version: .*$'
    line: "version: \"0.1.0+{{ glimesh_git_hash.stdout }}\","

- name: install mix dependencies
  command: mix do deps.get, deps.compile
  args:
    chdir: "{{ glimesh_web_build_dir }}"
  environment:
    MIX_ENV: prod
  # when: glimesh.changed

- name: install npm asset deps
  command: npm --prefix ./assets ci --progress=false --no-audit --loglevel=error
  args:
    chdir: "{{ glimesh_web_build_dir }}"
  # when: glimesh.changed

- name: build static assets
  command: npm run --prefix ./assets deploy
  args:
    chdir: "{{ glimesh_web_build_dir }}"
  # when: glimesh.changed

- name: digest static assets
  command: mix phx.digest
  args:
    chdir: "{{ glimesh_web_build_dir }}"
  # when: glimesh.changed

- name: build glimesh.tv
  command: mix do compile --force, release --force --overwrite
  args:
    chdir: "{{ glimesh_web_build_dir }}"
  environment:
    MIX_ENV: prod
  # when: glimesh.changed

- name: Ensure deploy state directories exist
  file:
    path: "{{ glimesh_web_host_dir }}-{{ item }}"
    state: directory
    owner: nobody
    recurse: yes
  with_items:
    - "old"
    - "new"

- name: Copy currently live files to old directory
  synchronize:
    src: "{{ glimesh_web_host_dir }}"
    dest: "{{ glimesh_web_host_dir }}-old"
    links: yes

- name: Copy newly built files to new store
  synchronize:
    src: "{{ glimesh_web_build_dir }}/_build/prod"
    dest: "{{ glimesh_web_host_dir }}-new"
    links: yes

- name: permissions
  file:
    path: "{{ glimesh_web_host_dir }}-new"
    owner: nobody
    recurse: yes

- name: setup unit file for glimesh.tv
  template:
    src: glimesh.service.j2
    dest: /etc/systemd/system/glimesh.service
    mode: 644
  tags: config

- name: reload systemd immediately
  systemd:
    daemon_reload: yes

- name: gracefully shut down old glimesh app
  systemd:
    name: glimesh
    state: stopped

- name: Change the symlink
  file:
    src: "{{ glimesh_web_host_dir }}-new"
    dest: "{{ glimesh_web_host_dir }}"
    state: link
    owner: nobody
    force: yes

- name: start new glimesh app
  systemd:
    name: glimesh
    state: started

- name: wait for service to be online
  wait_for:
    port: 8080
    delay: 5

- name: pause to make sure the other node can take over
  pause:
    seconds: 15
